---

  - name: "Change to the openshift-infra project"
    command: oc project openshift-infra

  - name: "Check for existing metrics infrastructure"
    command: oc delete all --all
    register: clean_result
    failed_when: "clean_result.rc == 1 and 'found' not in clean_result.stderr"

  - name: "Remove metrics secrets"
    command: oc delete secrets hawkular-cassandra-certificate hawkular-cassandra-secrets hawkular-metrics-account hawkular-metrics-certificate hawkular-metrics-secrets heapster-secrets
    register: secrets_result
    failed_when: "secrets_result.rc == 1 and 'not found' not in secrets_result.stderr"

  - name: "Delete existing metrics templates"
    command: oc delete template hawkular-cassandra-node-emptydir hawkular-cassandra-node-pv hawkular-cassandra-services hawkular-heapster hawkular-metrics hawkular-support
    register: templates_result
    failed_when: "templates_result.rc == 1 and 'not found' not in templates_result.stderr"

  - name: "Delete existing metrics service accounts"
    command: oc delete sa hawkular cassandra heapster
    register: sa_result
    failed_when: "sa_result.rc == 1 and 'not found' not in sa_result.stderr"

  - name: "Delete existing persistant volume claim"
    command: oc delete pvc metrics-cassandra-1
    register: pvc_result
    failed_when: "pvc_result.rc == 1 and 'not found' not in pvc_result.stderr"

  - name: "Create the metrics deployer service account"
    copy: dest=/tmp/metrics-deployer-sa.yaml
          src={{role_path}}/files/metrics-deployer-sa.yaml
          force=yes

  - name: "Add permissions to the metrics deployer service account"
    command: oadm policy add-role-to-user edit system:serviceaccount:openshift-infra:metrics-deployer

  - name: "Add cluster reader permissions to heapster service account"
    command: oadm policy add-cluster-role-to-user cluster-reader system:serviceaccount:openshift-infra:heapster

  - name: "Create a blank metrics-deployer secret"
    command: oc secrets new metrics-deployer nothing=/dev/null
    when: metrics_secret is not defined

  - name: "Process the metrics template"
    shell: oc process -f metrics.yml -v HAWKULAR_METRICS_HOSTNAME={{ metrics_hostname }},CASSANDRA_PV_SIZE={{ cassandra_size }} | oc create -f -
